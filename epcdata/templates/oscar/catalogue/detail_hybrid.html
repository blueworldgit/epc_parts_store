{% extends "oscar/catalogue/detail.html" %}
{% load static %}

{% block product_gallery %}
    <div class="product-gallery">
        <!-- Check if product has uploaded images first -->
        {% if product.images.exists %}
            <!-- Standard Oscar product images (uploaded via admin) -->
            <div class="uploaded-images">
                {{ block.super }}
            </div>
        {% else %}
            <!-- Fallback to SVG diagram if no images uploaded -->
            {% if product.attribute_values.all %}
                {% for attr_value in product.attribute_values.all %}
                    {% if attr_value.attribute.code == 'svg_diagram' and attr_value.value %}
                        <div class="svg-fallback-container">
                            <div class="alert alert-info">
                                <small>
                                    <i class="fa fa-info-circle"></i> 
                                    This is a technical diagram. Upload a product image via the admin dashboard to replace this.
                                </small>
                            </div>
                            
                            <div class="svg-diagram-container">
                                <h4>Technical Diagram</h4>
                                <div class="svg-diagram" id="svg-diagram-{{ product.id }}">
                                    {{ attr_value.value|safe }}
                                </div>
                                
                                <!-- SVG Controls -->
                                <div class="svg-controls mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomSVG('{{ product.id }}', 1.2)">
                                        <i class="fa fa-search-plus"></i> Zoom In
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomSVG('{{ product.id }}', 0.8)">
                                        <i class="fa fa-search-minus"></i> Zoom Out
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetSVG('{{ product.id }}')">
                                        <i class="fa fa-refresh"></i> Reset
                                    </button>
                                    
                                    {% if user.is_staff %}
                                        <a href="{% url 'admin:catalogue_product_change' product.id %}" class="btn btn-sm btn-warning">
                                            <i class="fa fa-upload"></i> Upload Better Image
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <!-- No images and no SVG -->
                <div class="no-image-container text-center p-4">
                    <i class="fa fa-image fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No image available</p>
                    {% if user.is_staff %}
                        <a href="{% url 'admin:catalogue_product_change' product.id %}" class="btn btn-primary">
                            <i class="fa fa-upload"></i> Upload Product Image
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}
        
        <!-- Show SVG as additional diagram even if images exist -->
        {% if product.images.exists %}
            {% for attr_value in product.attribute_values.all %}
                {% if attr_value.attribute.code == 'svg_diagram' and attr_value.value %}
                    <div class="additional-diagram mt-4">
                        <h5>Technical Diagram</h5>
                        <div class="svg-diagram" id="svg-diagram-additional-{{ product.id }}">
                            {{ attr_value.value|safe }}
                        </div>
                        <div class="svg-controls mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomSVG('additional-{{ product.id }}', 1.2)">
                                <i class="fa fa-search-plus"></i> Zoom In
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomSVG('additional-{{ product.id }}', 0.8)">
                                <i class="fa fa-search-minus"></i> Zoom Out
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetSVG('additional-{{ product.id }}')">
                                <i class="fa fa-refresh"></i> Reset
                            </button>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}

{% block extrascripts %}
    {{ block.super }}
    <script>
    let svgScales = {};
    
    function zoomSVG(productId, factor) {
        const container = document.getElementById('svg-diagram-' + productId);
        const svg = container ? container.querySelector('svg') : null;
        
        if (!svg) return;
        
        if (!svgScales[productId]) {
            svgScales[productId] = 1;
        }
        
        svgScales[productId] *= factor;
        svg.style.transform = `scale(${svgScales[productId]})`;
        svg.style.transformOrigin = 'top left';
    }
    
    function resetSVG(productId) {
        const container = document.getElementById('svg-diagram-' + productId);
        const svg = container ? container.querySelector('svg') : null;
        
        if (!svg) return;
        
        svgScales[productId] = 1;
        svg.style.transform = 'scale(1)';
    }
    
    // Initialize SVG styling
    document.addEventListener('DOMContentLoaded', function() {
        const svgContainers = document.querySelectorAll('.svg-diagram');
        svgContainers.forEach(function(container) {
            const svg = container.querySelector('svg');
            if (svg) {
                // Make SVG responsive
                svg.style.maxWidth = '100%';
                svg.style.height = 'auto';
                svg.style.border = '1px solid #ddd';
                svg.style.borderRadius = '4px';
                svg.style.backgroundColor = '#fff';
                svg.style.padding = '10px';
            }
        });
    });
    </script>
{% endblock %}

{% block extrastyles %}
    {{ block.super }}
    <style>
    .svg-fallback-container {
        border: 2px dashed #007bff;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9ff;
    }
    
    .svg-diagram-container,
    .additional-diagram {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    
    .svg-diagram {
        text-align: center;
        overflow: auto;
        max-height: 600px;
        background: white;
        border-radius: 4px;
        padding: 10px;
    }
    
    .svg-controls {
        text-align: center;
    }
    
    .svg-controls .btn {
        margin: 0 2px;
    }
    
    .svg-diagram svg {
        transition: transform 0.3s ease;
        cursor: grab;
    }
    
    .svg-diagram svg:active {
        cursor: grabbing;
    }
    
    .no-image-container {
        border: 2px dashed #6c757d;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    
    .additional-diagram {
        background-color: #fff;
        border-color: #28a745;
    }
    
    .additional-diagram h5 {
        color: #28a745;
        margin-bottom: 15px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .svg-diagram-container,
        .additional-diagram {
            margin: 10px 0;
            padding: 10px;
        }
        
        .svg-controls .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }
    </style>
{% endblock %}
