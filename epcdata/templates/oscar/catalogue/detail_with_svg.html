{% extends "oscar/catalogue/detail.html" %}
{% load static %}

{% block product_gallery %}
    <div class="product-gallery">
        <!-- Standard Oscar product images -->
        {{ block.super }}
        
        <!-- SVG Diagram Display -->
        {% if product.attribute_values.all %}
            {% for attr_value in product.attribute_values.all %}
                {% if attr_value.attribute.code == 'svg_diagram' and attr_value.value %}
                    <div class="svg-diagram-container">
                        <h4>Technical Diagram</h4>
                        <div class="svg-diagram" id="svg-diagram-{{ product.id }}">
                            {{ attr_value.value|safe }}
                        </div>
                        
                        <!-- SVG Controls -->
                        <div class="svg-controls mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomSVG('{{ product.id }}', 1.2)">
                                <i class="fa fa-search-plus"></i> Zoom In
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="zoomSVG('{{ product.id }}', 0.8)">
                                <i class="fa fa-search-minus"></i> Zoom Out
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetSVG('{{ product.id }}')">
                                <i class="fa fa-refresh"></i> Reset
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="downloadSVG('{{ product.id }}')">
                                <i class="fa fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}

{% block extrascripts %}
    {{ block.super }}
    <script>
    let svgScales = {};
    
    function zoomSVG(productId, factor) {
        const container = document.getElementById('svg-diagram-' + productId);
        const svg = container.querySelector('svg');
        
        if (!svg) return;
        
        if (!svgScales[productId]) {
            svgScales[productId] = 1;
        }
        
        svgScales[productId] *= factor;
        svg.style.transform = `scale(${svgScales[productId]})`;
        svg.style.transformOrigin = 'top left';
    }
    
    function resetSVG(productId) {
        const container = document.getElementById('svg-diagram-' + productId);
        const svg = container.querySelector('svg');
        
        if (!svg) return;
        
        svgScales[productId] = 1;
        svg.style.transform = 'scale(1)';
    }
    
    function downloadSVG(productId) {
        const container = document.getElementById('svg-diagram-' + productId);
        const svg = container.querySelector('svg');
        
        if (!svg) return;
        
        const svgData = new XMLSerializer().serializeToString(svg);
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const svgUrl = URL.createObjectURL(svgBlob);
        
        const downloadLink = document.createElement('a');
        downloadLink.href = svgUrl;
        downloadLink.download = 'product-diagram-{{ product.upc }}.svg';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        URL.revokeObjectURL(svgUrl);
    }
    
    // Initialize SVG styling
    document.addEventListener('DOMContentLoaded', function() {
        const svgContainers = document.querySelectorAll('.svg-diagram');
        svgContainers.forEach(function(container) {
            const svg = container.querySelector('svg');
            if (svg) {
                // Make SVG responsive
                svg.style.maxWidth = '100%';
                svg.style.height = 'auto';
                svg.style.border = '1px solid #ddd';
                svg.style.borderRadius = '4px';
                svg.style.backgroundColor = '#fff';
                svg.style.padding = '10px';
            }
        });
    });
    </script>
{% endblock %}

{% block extrastyles %}
    {{ block.super }}
    <style>
    .svg-diagram-container {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    
    .svg-diagram {
        text-align: center;
        overflow: auto;
        max-height: 600px;
        background: white;
        border-radius: 4px;
        padding: 10px;
    }
    
    .svg-controls {
        text-align: center;
    }
    
    .svg-controls .btn {
        margin: 0 2px;
    }
    
    .svg-diagram svg {
        transition: transform 0.3s ease;
        cursor: grab;
    }
    
    .svg-diagram svg:active {
        cursor: grabbing;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .svg-diagram-container {
            margin: 10px 0;
            padding: 10px;
        }
        
        .svg-controls .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }
    </style>
{% endblock %}
