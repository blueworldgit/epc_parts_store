{% extends "oscar/checkout/layout.html" %}
{% load i18n %}

{% block title %}
    {% trans "Payment" %} | {{ block.super }}
{% endblock %}

{% block checkout_nav %}
    {% include 'oscar/checkout/nav.html' with step=3 %}
{% endblock %}

{% block checkout_form %}
<div class="worldpay-hosted-checkout">
    <h4>{% trans "Secure Payment" %}</h4>
    <p class="text-muted">{% trans "You will be redirected to Worldpay's secure payment page to complete your purchase" %}</p>
    
    <div class="payment-amount mb-4">
        <div class="alert alert-info">
            <h5 class="mb-0">{% trans "Order Total:" %} £{{ order_total|floatformat:2 }}</h5>
        </div>
    </div>
    
    <div class="checkout-summary mb-4">
        <h5>{% trans "Order Summary" %}</h5>
        <div class="basket-items">
            {% for line in basket.all_lines %}
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <strong>{{ line.product.title }}</strong>
                    {% if line.quantity > 1 %}
                        <small class="text-muted">({% trans "Quantity:" %} {{ line.quantity }})</small>
                    {% endif %}
                </div>
                <div>£{{ line.line_price_incl_tax|floatformat:2 }}</div>
            </div>
            {% endfor %}
        </div>
        <div class="d-flex justify-content-between align-items-center py-2 border-top mt-2">
            <strong>{% trans "Total:" %}</strong>
            <strong>£{{ basket.total_incl_tax|floatformat:2 }}</strong>
        </div>
    </div>
    
    <div class="payment-redirect-form">
        <form method="post" action="{{ payment_url }}" id="worldpay-hosted-form">
            {% for field in form %}
                {{ field }}
            {% endfor %}
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fa fa-credit-card"></i> {% trans "Continue to Secure Payment" %}
                </button>
            </div>
            
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="fa fa-shield"></i> {% trans "You will be redirected to Worldpay's secure payment page" %}
                </small>
            </div>
        </form>
    </div>
    
    <div class="payment-info mt-4">
        <div class="row">
            <div class="col-md-4 text-center">
                <i class="fa fa-lock fa-2x text-success mb-2"></i>
                <h6>{% trans "SSL Encrypted" %}</h6>
                <small class="text-muted">{% trans "Your payment is fully encrypted" %}</small>
            </div>
            <div class="col-md-4 text-center">
                <i class="fa fa-shield fa-2x text-success mb-2"></i>
                <h6>{% trans "PCI Compliant" %}</h6>
                <small class="text-muted">{% trans "Worldpay meets highest security standards" %}</small>
            </div>
            <div class="col-md-4 text-center">
                <i class="fa fa-check-circle fa-2x text-success mb-2"></i>
                <h6>{% trans "Fraud Protection" %}</h6>
                <small class="text-muted">{% trans "Advanced fraud detection" %}</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block checkout_sidebar %}
<div class="checkout-sidebar">
    <h5>{% trans "Payment Security" %}</h5>
    <div class="security-info">
        <div class="mb-3">
            <i class="fa fa-globe text-primary"></i>
            <strong>{% trans "Hosted Payment" %}</strong>
            <p class="small text-muted">{% trans "Payment processed on Worldpay's secure servers" %}</p>
        </div>
        <div class="mb-3">
            <i class="fa fa-credit-card text-primary"></i>
            <strong>{% trans "Card Details" %}</strong>
            <p class="small text-muted">{% trans "Your card details never touch our servers" %}</p>
        </div>
        <div class="mb-3">
            <i class="fa fa-undo text-primary"></i>
            <strong>{% trans "Easy Returns" %}</strong>
            <p class="small text-muted">{% trans "Return to complete your order if needed" %}</p>
        </div>
    </div>
    
    <div class="accepted-cards mt-4">
        <h6>{% trans "We Accept" %}</h6>
        <div class="card-logos">
            <i class="fa fa-cc-visa fa-2x text-primary mr-1"></i>
            <i class="fa fa-cc-mastercard fa-2x text-warning mr-1"></i>
            <i class="fa fa-cc-amex fa-2x text-info mr-1"></i>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
{{ block.super }}
<script>
// Auto-submit the form after a short delay to give user time to read
document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('worldpay-hosted-form');
    var submitBtn = form.querySelector('button[type="submit"]');
    
    // Optional: Auto-submit after 3 seconds (uncomment if desired)
    /*
    setTimeout(function() {
        submitBtn.textContent = '{% trans "Redirecting..." %}';
        submitBtn.disabled = true;
        form.submit();
    }, 3000);
    */
    
    // Show loading state when form is submitted
    form.addEventListener('submit', function() {
        submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> {% trans "Redirecting to Worldpay..." %}';
        submitBtn.disabled = true;
    });
});
</script>
{% endblock %}
